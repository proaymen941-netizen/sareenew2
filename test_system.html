<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
        h1 {
            color: #1e40af;
            margin-bottom: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .test-section h3 {
            color: #059669;
            margin-bottom: 10px;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            margin: 5px;
            font-weight: bold;
        }
        .success {
            background: #d1fae5;
            color: #065f46;
        }
        .error {
            background: #fee2e2;
            color: #991b1b;
        }
        .pending {
            background: #fef3c7;
            color: #92400e;
        }
        .info {
            background: #dbeafe;
            color: #1e40af;
        }
        button {
            background: #1e40af;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #1e3a8a;
        }
        .log {
            background: #f9fafb;
            padding: 10px;
            margin: 10px 0;
            border-right: 4px solid #1e40af;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            padding: 8px;
            text-align: right;
            border: 1px solid #ddd;
        }
        th {
            background: #f3f4f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„</h1>
        
        <div style="margin-bottom: 20px;">
            <button onclick="runAllTests()">â–¶ï¸ ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</button>
            <button onclick="clearLogs()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
            <button onclick="location.href='/'">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù†Ø¸Ø§Ù…</button>
        </div>

        <div id="results"></div>
        
        <div class="test-section">
            <h3>ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
            <div id="testLog" class="log"></div>
        </div>
    </div>

    <script src="js/db.js"></script>
    <script>
        const testLog = document.getElementById('testLog');
        const resultsDiv = document.getElementById('results');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logEntry.style.color = type === 'error' ? '#dc2626' : type === 'success' ? '#059669' : '#1e40af';
            testLog.appendChild(logEntry);
            testLog.scrollTop = testLog.scrollHeight;
        }

        function clearLogs() {
            testLog.innerHTML = '';
            resultsDiv.innerHTML = '';
        }

        function createStatusBadge(status) {
            return `<span class="status ${status}">${status === 'success' ? 'âœ… Ù†Ø¬Ø­' : status === 'error' ? 'âŒ ÙØ´Ù„' : 'â³ Ø¬Ø§Ø±ÙŠ'}</span>`;
        }

        async function runAllTests() {
            clearLogs();
            log('ğŸš€ Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„...', 'info');
            
            const tests = [
                { name: 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±', func: testServerConnection },
                { name: 'Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª IndexedDB', func: testDatabase },
                { name: 'Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', func: testInventory },
                { name: 'Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†', func: testEmployees },
                { name: 'Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø³Ù… Ù†Ù‚Ø·Ø© Ø§Ù„ÙƒØ§Ø´ÙŠØ± POS', func: testPOS },
                { name: 'Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø³Ù… ÙƒØ§Ø´ÙŠØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†', func: testEmployeeCashier },
                { name: 'Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†', func: testSuppliers },
                { name: 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ', func: testFinance },
                { name: 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±', func: testReports },
                { name: 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', func: testSettings }
            ];

            let resultsHTML = '<table><thead><tr><th>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th></tr></thead><tbody>';
            
            for (const test of tests) {
                log(`ğŸ“ Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„: ${test.name}...`);
                const result = await test.func();
                resultsHTML += `<tr><td>${test.name}</td><td>${createStatusBadge(result.status)}</td><td>${result.message}</td></tr>`;
                log(`${result.status === 'success' ? 'âœ…' : 'âŒ'} ${test.name}: ${result.message}`, result.status);
            }
            
            resultsHTML += '</tbody></table>';
            resultsDiv.innerHTML = resultsHTML;
            
            log('âœ¨ Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„!', 'success');
        }

        // 1. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±
        async function testServerConnection() {
            try {
                const response = await fetch('/');
                if (response.ok) {
                    return { status: 'success', message: 'Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° 5000' };
                } else {
                    return { status: 'error', message: `Ø®Ø·Ø£: ${response.status}` };
                }
            } catch (error) {
                return { status: 'error', message: `ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}` };
            }
        }

        // 2. Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        async function testDatabase() {
            try {
                await db.init();
                
                // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„ÙƒØªØ§Ø¨Ø©
                const testItem = {
                    name: 'Ø§Ø®ØªØ¨Ø§Ø±',
                    category: 'test',
                    unit: 'Ù‚Ø·Ø¹Ø©',
                    quantity: 1,
                    purchase_price: 10,
                    sell_price: 15
                };
                
                const id = await db.add('inventory_items', testItem);
                const retrieved = await db.getById('inventory_items', id);
                await db.delete('inventory_items', id);
                
                if (retrieved && retrieved.name === 'Ø§Ø®ØªØ¨Ø§Ø±') {
                    return { status: 'success', message: 'Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (Ø¥Ø¶Ø§ÙØ©ØŒ Ù‚Ø±Ø§Ø¡Ø©ØŒ Ø­Ø°Ù)' };
                } else {
                    return { status: 'error', message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª' };
                }
            } catch (error) {
                return { status: 'error', message: `Ø®Ø·Ø£: ${error.message}` };
            }
        }

        // 3. Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        async function testInventory() {
            try {
                const items = await db.getAll('inventory_items');
                const movements = await db.getAll('inventory_movements');
                return { status: 'success', message: `Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${items.length} ØµÙ†ÙØŒ ${movements.length} Ø­Ø±ÙƒØ©` };
            } catch (error) {
                return { status: 'error', message: `Ø®Ø·Ø£: ${error.message}` };
            }
        }

        // 4. Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
        async function testEmployees() {
            try {
                const employees = await db.getAll('employees');
                const attendance = await db.getAll('attendance');
                const salaries = await db.getAll('salaries');
                return { status: 'success', message: `Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: ${employees.length} Ù…ÙˆØ¸ÙØŒ ${attendance.length} Ø­Ø¶ÙˆØ±ØŒ ${salaries.length} Ø±Ø§ØªØ¨` };
            } catch (error) {
                return { status: 'error', message: `Ø®Ø·Ø£: ${error.message}` };
            }
        }

        // 5. Ø§Ø®ØªØ¨Ø§Ø± Ù†Ù‚Ø·Ø© Ø§Ù„ÙƒØ§Ø´ÙŠØ± POS
        async function testPOS() {
            try {
                const orders = await db.getAll('pos_orders');
                return { status: 'success', message: `Ù†Ù‚Ø·Ø© Ø§Ù„ÙƒØ§Ø´ÙŠØ±: ${orders.length} Ø·Ù„Ø¨` };
            } catch (error) {
                return { status: 'error', message: `Ø®Ø·Ø£: ${error.message}` };
            }
        }

        // 6. Ø§Ø®ØªØ¨Ø§Ø± ÙƒØ§Ø´ÙŠØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
        async function testEmployeeCashier() {
            try {
                const meals = await db.getAll('employee_meals');
                const orders = await db.getAll('employee_meal_orders');
                return { status: 'success', message: `ÙƒØ§Ø´ÙŠØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: ${meals.length} ÙˆØ¬Ø¨Ø©ØŒ ${orders.length} Ø·Ù„Ø¨` };
            } catch (error) {
                return { status: 'error', message: `Ø®Ø·Ø£: ${error.message}` };
            }
        }

        // 7. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
        async function testSuppliers() {
            try {
                const suppliers = await db.getAll('suppliers');
                const invoices = await db.getAll('purchase_invoices');
                const payments = await db.getAll('supplier_payments');
                return { status: 'success', message: `Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†: ${suppliers.length} Ù…ÙˆØ±Ø¯ØŒ ${invoices.length} ÙØ§ØªÙˆØ±Ø©ØŒ ${payments.length} Ø¯ÙØ¹Ø©` };
            } catch (error) {
                return { status: 'error', message: `Ø®Ø·Ø£: ${error.message}` };
            }
        }

        // 8. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ
        async function testFinance() {
            try {
                const revenues = await db.getAll('revenues');
                const expenses = await db.getAll('expenses');
                return { status: 'success', message: `Ø§Ù„Ù…Ø§Ù„ÙŠØ©: ${revenues.length} Ø¥ÙŠØ±Ø§Ø¯ØŒ ${expenses.length} Ù…ØµØ±ÙˆÙ` };
            } catch (error) {
                return { status: 'error', message: `Ø®Ø·Ø£: ${error.message}` };
            }
        }

        // 9. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
        async function testReports() {
            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
                const items = await db.getAll('inventory_items');
                const employees = await db.getAll('employees');
                return { status: 'success', message: `Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ©` };
            } catch (error) {
                return { status: 'error', message: `Ø®Ø·Ø£: ${error.message}` };
            }
        }

        // 10. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        async function testSettings() {
            try {
                // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
                const data = await db.exportData();
                if (data && Object.keys(data).length > 0) {
                    return { status: 'success', message: `Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙŠØ¹Ù…Ù„ØŒ ${Object.keys(data).length} Ø¬Ø¯ÙˆÙ„` };
                } else {
                    return { status: 'error', message: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±' };
                }
            } catch (error) {
                return { status: 'error', message: `Ø®Ø·Ø£: ${error.message}` };
            }
        }

        // ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        window.addEventListener('DOMContentLoaded', () => {
            log('ğŸ“± ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø§Ù‡Ø²Ø©', 'success');
        });
    </script>
</body>
</html>
